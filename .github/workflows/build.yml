name: Build

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Apple Certificate (macOS only)
        if: matrix.os == 'macos-latest'
        working-directory: .
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Decode certificate
          echo "$APPLE_CERTIFICATE" | base64 --decode > /tmp/certificate.p12

          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -hex 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate to keychain
          security import /tmp/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Make keychain available
          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain

          # Cleanup
          rm /tmp/certificate.p12

      - name: Install frontend dependencies
        run: npm ci

      # CI Build (non-release): just build and upload artifacts
      - name: Build Tauri app
        if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: npx tauri build --target ${{ matrix.target }}

      - name: Upload artifacts
        if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/upload-artifact@v4
        with:
          name: tauri-bundle-${{ matrix.os }}-${{ matrix.target }}
          path: src-tauri/target/${{ matrix.target }}/release/bundle
          retention-days: 7

      # Release Build: use tauri-action to create GitHub release
      - name: Build and Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'GTD Timer App ${{ github.ref_name }}'
          releaseBody: 'See the assets below to download the app for your platform.'
          releaseDraft: true
          prerelease: false
          args: --target ${{ matrix.target }}

      - name: Package Windows portable build
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $releaseDir = "src-tauri/target/${{ matrix.target }}/release"
          $portableDir = "src-tauri/target/${{ matrix.target }}/release/bundle/portable"
          New-Item -ItemType Directory -Force -Path $portableDir | Out-Null
          $zipPath = "$portableDir/gtd-timer-app-${{ matrix.target }}-portable.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath }
          $exePath = Join-Path $releaseDir "gtd-timer-app.exe"
          if (-not (Test-Path $exePath)) {
            $exePath = Get-ChildItem -Path $releaseDir -Filter *.exe | Select-Object -First 1 | ForEach-Object { $_.FullName }
          }
          if (-not $exePath) {
            throw "Portable packaging failed: no .exe found in $releaseDir"
          }
          Compress-Archive -Path $exePath -DestinationPath $zipPath

      - name: Upload portable build to release
        if: startsWith(github.ref, 'refs/tags/v') && matrix.os == 'windows-latest'
        uses: softprops/action-gh-release@v2
        with:
          files: src-tauri/target/${{ matrix.target }}/release/bundle/portable/gtd-timer-app-${{ matrix.target }}-portable.zip
